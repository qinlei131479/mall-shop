<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tigshop.mapper.vendor.VendorShopBindMapper">

    <select id="pageVendorShopBind" resultType="com.tigshop.bean.vo.vendor.shopbind.VendorShopBindVO">
        SELECT
        vsb.shop_id AS shopId,
        s.shop_title AS shopTitle,
        s.shop_logo AS shopLogo,
        s.merchant_id AS merchantId,
        m.corporate_name AS "merchantName",
        vsb.add_time AS addTime
        FROM
        vendor_shop_bind vsb
        LEFT JOIN shop s ON vsb.shop_id = s.shop_id
        LEFT JOIN merchant m ON s.merchant_id = m.merchant_id
        <!-- 如果排序字段是 upProductCount 或 downProductCount，才关联 product -->
        <if test="param.sortField == 'upProductCount' or param.sortField == 'downProductCount'">
            LEFT JOIN product p
            ON p.vendor_id = vsb.vendor_id
            AND p.shop_id = vsb.shop_id
        </if>

        <!-- 如果排序字段是 orderCount，才关联 order -->
        <if test="param.sortField == 'orderCount'">
            LEFT JOIN `order` o
            ON o.vendor_id = vsb.vendor_id
            AND o.shop_id = vsb.shop_id
        </if>

        <!-- 如果排序字段是 orderAmount，才关联 vendor_settlement_order -->
        <if test="param.sortField == 'orderAmount'">
            LEFT JOIN vendor_settlement_order vso
            ON vso.vendor_id = vsb.vendor_id
            AND vso.shop_id = vsb.shop_id
        </if>
        WHERE
        vsb.vendor_id = #{vendorId}
        <if test="param.keyword != null and param.keyword != ''">
            AND s.shop_title LIKE CONCAT('%', #{param.keyword}, '%')
        </if>

        <if test="param.shopId != null and param.shopId != ''">
            AND vsb.shop_id = #{param.shopId}
        </if>
        <if test="param.merchantId != null">
            <choose>
                <when test="param.merchantId == 0">
                    AND vsb.shop_id = 0
                </when>
                <otherwise>
                    AND s.merchant_id = #{param.merchantId}
                </otherwise>
            </choose>
        </if>
        <if test="param.startTime != null and param.startTime != ''">
            AND vsb.add_time &gt;= UNIX_TIMESTAMP(#{param.startTime})
        </if>
        <if test="param.endTime != null and param.endTime != ''">
            AND vsb.add_time &lt;= UNIX_TIMESTAMP(#{param.endTime})
        </if>
        group by vsb.shop_id
        <if test="param.sortField != null and param.sortOrder != null">
            ORDER BY
            <choose>
                <when test="param.sortField == 'upProductCount'">
                    SUM(CASE
                    WHEN p.product_status = 1
                    AND p.is_delete = 0
                    THEN 1 ELSE 0 END)
                </when>
                <when test="param.sortField == 'downProductCount'">
                    SUM(CASE
                    WHEN p.product_status = 0
                    AND p.is_delete = 0
                    THEN 1 ELSE 0 END)
                </when>
                <when test="param.sortField == 'orderCount'">
                    COUNT(DISTINCT CASE
                    WHEN o.pay_status = 2
                    THEN o.order_id END)
                </when>
                <when test="param.sortField == 'orderAmount'">
                    COALESCE(SUM(vso.amount), 0)
                </when>
                <otherwise>
                    vsb.shop_id
                </otherwise>
            </choose>
            <choose>
                <when test="param.sortOrder == 'asc'">ASC</when>
                <when test="param.sortOrder == 'desc'">DESC</when>
                <otherwise>DESC</otherwise>
            </choose>
        </if>
    </select>
    <select id="pageProductList" resultType="com.tigshop.bean.vo.vendor.shopbind.VendorShopProductBindVO">
        SELECT
            p.product_id AS id,
            p.pic_thumb AS picThumb,
            p.product_name AS productName,
            p.product_sn AS productSn,
            p.product_price AS productPrice,
            p.category_id AS productCategoryId,
            p.brand_id AS productBrandId,
            p.product_status AS productStatus,
            p.vendor_product_id AS vendorProductId
        FROM
            product p
            LEFT JOIN vendor_product_sku vps ON p.vendor_product_id = vps.vendor_product_id
        WHERE
            p.vendor_id = #{vendorId}
            AND p.shop_id = #{param.shopId}
        <if test="param.keyword != null and param.keyword != ''">
            AND (p.product_sn like CONCAT('%', #{param.keyword}, '%') or p.product_name like CONCAT('%', #{param.keyword}, '%'))
        </if>
        <if test="param.productStatus != null">
            AND p.product_status = #{param.productStatus}
        </if>
        <if test="param.startDate != null and param.startDate != ''">
            AND p.add_time &gt;= UNIX_TIMESTAMP(#{param.startDate})
        </if>
        <if test="param.endDate != null and param.endDate != ''">
            AND p.add_time &lt;= UNIX_TIMESTAMP(#{param.endDate})
        </if>
        GROUP BY p.product_id
        ORDER BY
        <choose>
            <when test="param.sortField == 'productSupplyPrice'">
                MIN(vps.supply_price)
            </when>
            <when test="param.sortField == 'productStock'">
                SUM(vps.sku_stock)
            </when>
            <when test="param.sortField == 'salesVolume'">
                (
                SELECT SUM(oi.quantity)
                FROM order_item oi
                LEFT JOIN `order` o ON o.order_id = oi.order_id
                WHERE oi.product_id = p.product_id
                AND o.shop_id = p.shop_id
                AND o.order_status != 3
                )
            </when>
            <otherwise>
                p.product_id
            </otherwise>
        </choose>
        <choose>
            <when test="param.sortOrder == 'asc'">ASC</when>
            <when test="param.sortOrder == 'desc'">DESC</when>
            <otherwise>DESC</otherwise>
        </choose>
    </select>
    <select id="pageOrderList" resultType="com.tigshop.bean.vo.vendor.shopbind.VendorShopOrderBindVO">
        SELECT
            o.order_id orderId,
            u.user_id userId,
            o.shop_id shopId
        FROM
            `order` o
        LEFT JOIN `user` u ON o.user_id = u.user_id
        WHERE
        o.vendor_id = #{vendorId}
        AND o.shop_id = #{param.shopId}
        <if test="param.keyword != null and param.keyword != ''">
            AND (o.order_sn like CONCAT('%', #{param.keyword}, '%') or u.username like CONCAT('%', #{param.keyword}, '%'))
        </if>
        <if test="param.orderStatus != null and param.orderStatus != -1">
            AND o.order_status = #{param.orderStatus}
        </if>
        <if test="param.startDate != null and param.startDate != ''">
            AND o.add_time &gt;= UNIX_TIMESTAMP(#{param.startDate})
        </if>
        <if test="param.endDate != null and param.endDate != ''">
            AND o.add_time &lt;= UNIX_TIMESTAMP(#{param.endDate})
        </if>
        GROUP BY o.order_id
        ORDER BY
        <choose>
            <when test="param.sortField == 'orderId'">
                o.order_id
            </when>
            <when test="param.sortField == 'totalAmount'">
                o.total_amount
            </when>
            <otherwise>
                o.order_id
            </otherwise>
        </choose>
        <choose>
            <when test="param.sortOrder == 'asc'">ASC</when>
            <when test="param.sortOrder == 'desc'">DESC</when>
            <otherwise>DESC</otherwise>
        </choose>
    </select>
    <select id="merchantList" resultType="com.tigshop.bean.vo.merchant.MerchantVO">
        SELECT
        CASE
        WHEN vsb.shop_id = 0 THEN 0
        ELSE m.merchant_id
        END AS merchantId,
        CASE
        WHEN vsb.shop_id = 0 THEN '自营商户'
        ELSE m.corporate_name
        END AS companyName
        FROM
        vendor_shop_bind vsb
        LEFT JOIN shop s ON vsb.shop_id = s.shop_id
        LEFT JOIN merchant m ON s.merchant_id = m.merchant_id
        WHERE
        vsb.vendor_id = #{vendorId}
        <if test="param.keyword != null and param.keyword != ''">
            AND m.corporate_name LIKE CONCAT('%', #{param.keyword}, '%')
        </if>
        GROUP BY m.merchant_id, m.company_name
        ORDER BY vsb.add_time DESC
    </select>

    <select id="shopList" resultType="com.tigshop.bean.vo.shop.ShopVO">
        SELECT
        CASE
        WHEN vsb.shop_id = 0 THEN 0
        ELSE s.shop_id
        END AS shopId,
        CASE
        WHEN vsb.shop_id = 0 THEN '自营店铺'
        ELSE s.shop_title
        END AS shopTitle
        FROM
        vendor_shop_bind vsb
        LEFT JOIN shop s ON vsb.shop_id = s.shop_id
        LEFT JOIN merchant m ON s.merchant_id = m.merchant_id
        WHERE
        vsb.vendor_id = #{vendorId}
        <if test="param.keyword != null and param.keyword != ''">
            AND s.shop_title LIKE CONCAT('%', #{param.keyword}, '%')
        </if>
        GROUP BY s.shop_id, s.shop_title
        ORDER BY vsb.add_time DESC
    </select>

</mapper>
